name: C/C++ CI & Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]

env:
  APP_NAME: simple_cplus_calculator
  APP_VERSION: 1.0.0
  APP_DESCRIPTION: "A simple terminal cplus calculator"
  MAINTAINER: "ViruSilvester <onesilonecho@gmail.com>"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ make rpm
    
    - name: Build application
      run: |
        g++ -std=c++17 -O2 -static-libgcc -static-libstdc++ -o ${{ env.APP_NAME }} main.cpp
        chmod +x ${{ env.APP_NAME }}
    
    - name: Test executable
      run: |
        ./${{ env.APP_NAME }} --version || echo "Binary created successfully"
    
    - name: Create DEB package structure
      run: |
        mkdir -p deb-package/DEBIAN
        mkdir -p deb-package/usr/local/bin
        mkdir -p deb-package/usr/share/doc/${{ env.APP_NAME }}
        
        # Copy binary
        cp ${{ env.APP_NAME }} deb-package/usr/local/bin/
        
        # Create control file
        cat > deb-package/DEBIAN/control << EOF
        Package: ${{ env.APP_NAME }}
        Version: ${{ env.APP_VERSION }}
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: ${{ env.MAINTAINER }}
        Description: ${{ env.APP_DESCRIPTION }}
        EOF
        
        # Create copyright file
        cat > deb-package/usr/share/doc/${{ env.APP_NAME }}/copyright << EOF
        Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
        Upstream-Name: ${{ env.APP_NAME }}
        Source: https://github.com/${{ github.repository }}
        
        Files: *
        Copyright: $(date +%Y) ${{ env.MAINTAINER }}
        License: MIT
        EOF
        
        # Build DEB package
        dpkg-deb --build deb-package ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
    
    - name: Create RPM package structure
      run: |
        mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        
        # Create spec file
        cat > rpmbuild/SPECS/${{ env.APP_NAME }}.spec << EOF
        Name: ${{ env.APP_NAME }}
        Version: ${{ env.APP_VERSION }}
        Release: 1%{?dist}
        Summary: ${{ env.APP_DESCRIPTION }}
        License: MIT
        URL: https://github.com/${{ github.repository }}
        
        %description
        ${{ env.APP_DESCRIPTION }}
        
        %install
        mkdir -p %{buildroot}/usr/local/bin
        cp ${{ github.workspace }}/${{ env.APP_NAME }} %{buildroot}/usr/local/bin/
        
        %files
        /usr/local/bin/${{ env.APP_NAME }}
        
        %changelog
        * $(date "+%a %b %d %Y") ${{ env.MAINTAINER }} - ${{ env.APP_VERSION }}-1
        - Initial package
        EOF
        
        # Build RPM package
        rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/${{ env.APP_NAME }}.spec
        cp rpmbuild/RPMS/x86_64/*.rpm ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.x86_64.rpm
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-packages
        path: |
          ${{ env.APP_NAME }}
          ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
          ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.x86_64.rpm
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Build application
      run: |
        cl /EHsc /O2 /Fe:${{ env.APP_NAME }}.exe main.cpp
      shell: cmd
    
    - name: Test executable
      run: |
        .\${{ env.APP_NAME }}.exe --version
      continue-on-error: true
    
    - name: Create ZIP package
      run: |
        Compress-Archive -Path ${{ env.APP_NAME }}.exe -DestinationPath ${{ env.APP_NAME }}-windows-x64.zip
      shell: pwsh
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: |
          ${{ env.APP_NAME }}.exe
          ${{ env.APP_NAME }}-windows-x64.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build application
      run: |
        clang++ -std=c++17 -O2 -o ${{ env.APP_NAME }} main.cpp
        chmod +x ${{ env.APP_NAME }}
    
    - name: Test executable
      run: |
        ./${{ env.APP_NAME }} --version || echo "Binary created successfully"
    
    - name: Create macOS app bundle
      run: |
        mkdir -p ${{ env.APP_NAME }}.app/Contents/MacOS
        mkdir -p ${{ env.APP_NAME }}.app/Contents/Resources
        
        cp ${{ env.APP_NAME }} ${{ env.APP_NAME }}.app/Contents/MacOS/
        
        # Create Info.plist
        cat > ${{ env.APP_NAME }}.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleIdentifier</key>
            <string>com.example.${{ env.APP_NAME }}</string>
            <key>CFBundleName</key>
            <string>${{ env.APP_NAME }}</string>
            <key>CFBundleVersion</key>
            <string>${{ env.APP_VERSION }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ env.APP_VERSION }}</string>
        </dict>
        </plist>
        EOF
        
        # Create DMG (requires hdiutil)
        hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder ${{ env.APP_NAME }}.app -ov -format UDZO ${{ env.APP_NAME }}-macos-universal.dmg
    
    - name: Create TAR.GZ package
      run: |
        tar -czf ${{ env.APP_NAME }}-macos-x64.tar.gz ${{ env.APP_NAME }}
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-package
        path: |
          ${{ env.APP_NAME }}
          ${{ env.APP_NAME }}-macos-x64.tar.gz
          ${{ env.APP_NAME }}-macos-universal.dmg
        retention-days: 30

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Display structure
      run: ls -R
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          linux-packages/${{ env.APP_NAME }}
          linux-packages/${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
          linux-packages/${{ env.APP_NAME }}-${{ env.APP_VERSION }}.x86_64.rpm
          windows-package/${{ env.APP_NAME }}.exe
          windows-package/${{ env.APP_NAME }}-windows-x64.zip
          macos-package/${{ env.APP_NAME }}
          macos-package/${{ env.APP_NAME }}-macos-x64.tar.gz
          macos-package/${{ env.APP_NAME }}-macos-universal.dmg
        body: |
          ## Release ${{ github.ref_name }}
          
          Multi-platform build of ${{ env.APP_NAME }}
          
          ### Downloads
          
          **Linux:**
          - üì¶ `.deb` package for Debian/Ubuntu
          - üì¶ `.rpm` package for RedHat/Fedora/CentOS
          - üîß Standalone binary
          
          **Windows:**
          - üíª `.exe` executable
          - üì¶ `.zip` package
          
          **macOS:**
          - üçé `.dmg` disk image
          - üì¶ `.tar.gz` archive
          - üîß Standalone binary
          
          ### Installation
          
          **Debian/Ubuntu:**
          ```bash
          sudo dpkg -i ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
          ```
          
          **RedHat/Fedora/CentOS:**
          ```bash
          sudo rpm -i ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.x86_64.rpm
          ```
          
          **macOS:**
          ```bash
          # Open the DMG and drag to Applications
          # Or use the standalone binary
          chmod +x ${{ env.APP_NAME }}
          ./${{ env.APP_NAME }}
          ```
          
          **Windows:**
          ```cmd
          ${{ env.APP_NAME }}.exe
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
