name: C/C++ Build & Release

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main" ]

env:
  APP_NAME: fun-calculator

jobs:
# =========================
# LINUX BUILD + PACKAGING
# =========================
  linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install compiler & tools
      run: |
        sudo apt update
        sudo apt install -y g++ dpkg-dev rpm

    - name: Build binary
      run: |
        g++ -std=c++17 main.cpp -O2 -o $APP_NAME

    # ---------- DEB ----------
    - name: Build .deb package
      run: |
        VERSION=${GITHUB_REF_NAME#v}

        mkdir -p pkg/DEBIAN
        mkdir -p pkg/usr/bin

        cp $APP_NAME pkg/usr/bin/

        cat <<EOF > pkg/DEBIAN/control
        Package: $APP_NAME
        Version: $VERSION
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: Your Name <you@example.com>
        Description: Fun C++ terminal calculator
        EOF

        dpkg-deb --build pkg ${APP_NAME}_${VERSION}_amd64.deb

    # ---------- RPM ----------
    - name: Build .rpm package
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        mkdir -p src/$APP_NAME-$VERSION
        cp $APP_NAME src/$APP_NAME-$VERSION/

        tar czf rpmbuild/SOURCES/$APP_NAME-$VERSION.tar.gz -C src .

        cat <<EOF > rpmbuild/SPECS/$APP_NAME.spec
        Name: $APP_NAME
        Version: $VERSION
        Release: 1
        Summary: Fun C++ terminal calculator
        License: MIT

        %description
        Fun C++ terminal calculator

        %prep
        %setup -q

        %install
        mkdir -p %{buildroot}/usr/bin
        cp $APP_NAME %{buildroot}/usr/bin/

        %files
        /usr/bin/$APP_NAME
        EOF

        rpmbuild --define "_topdir $PWD/rpmbuild" -bb rpmbuild/SPECS/$APP_NAME.spec
        cp rpmbuild/RPMS/x86_64/*.rpm .

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-packages
        path: |
          *.deb
          *.rpm

# =========================
# WINDOWS BUILD
# =========================
  windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build (MSVC)
      run: |
        cl /std:c++17 main.cpp /O2 /Fe:fun-calculator.exe

    - name: Package
      run: |
        mkdir artifacts
        copy fun-calculator.exe artifacts\

    - uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: artifacts/

# =========================
# MACOS BUILD
# =========================
  macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build
      run: |
        clang++ -std=c++17 main.cpp -O2 -o fun-calculator

    - name: Package
      run: |
        mkdir artifacts
        tar czf artifacts/fun-calculator-macos.tar.gz fun-calculator

    - uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: artifacts/

# =========================
# RELEASE
# =========================
  release:
    needs: [linux, windows, macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: release-artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
